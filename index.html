<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Triple Phase LUT Calculator</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#000;color:#fff;font-family:Arial;margin:0;}
header{text-align:center;padding:25px;background:linear-gradient(90deg,#111,#000);}
.logo{width:90px;height:90px;border-radius:50%;margin-bottom:10px;
box-shadow:0 0 15px rgba(255,255,255,.2);object-fit:cover;}
.title{font-size:28px;font-weight:bold;letter-spacing:2px;}
.credit{font-size:14px;color:#aaa;}
.container{max-width:1000px;margin:auto;padding:20px;}
.card{background:#111;border-radius:15px;padding:20px;margin-bottom:20px;}
label{display:block;margin-top:12px;}
input{width:100%;padding:8px;margin-top:5px;background:#000;
border:1px solid #333;color:#fff;border-radius:6px;}
button{margin-top:15px;padding:12px;width:100%;
border:none;background:#fff;color:#000;font-weight:bold;
border-radius:8px;cursor:pointer;}
textarea{width:100%;height:180px;background:#000;color:#fff;
border:1px solid #333;border-radius:8px;padding:10px;
margin-top:15px;font-family:monospace;}
</style>
</head>

<body>

<header>
<img class="logo"
src="https://yt3.googleusercontent.com/G3NBG71dzJtbQ3ae2ERcVDRvXGEHaAlCO43-fnO-uilXeikc5mYWp2p2k4owzc4S5n0brzNC=s160-c-k-c0x00ffffff-no-rj">

<div class="title">Triple Phase LUT Velocity Calculator</div>
<div class="credit">Made by @repodatabase</div>
<div class="credit">Original Logic by @fugaz13</div>
</header>

<div class="container">

<div class="card">

<label>Input Range</label>
<input id="input_range" value="257">

<label>Phase 1 Velocity</label>
<input id="phase1_velocity" value="6.6">

<label>Phase 2 Velocity</label>
<input id="phase2_velocity" value="23">

<label>Phase 3 Velocity</label>
<input id="phase3_velocity" value="53">

<label>Phase 1 Cap</label>
<input id="phase1_cap" value="60">

<label>Phase 2 Start</label>
<input id="phase2_start" value="152">

<label>Phase 3 Start</label>
<input id="phase3_start" value="180">

<label>Smooth Factor</label>
<input id="smooth_factor" value="0.1">

<button onclick="generateCurve()">Generate LUT</button>
<button onclick="copyLUT()">Copy LUT</button>

<textarea id="lutOutput"></textarea>

</div>

<div class="card">
<h2>Velocity Graph</h2>
<canvas id="chart"></canvas>
</div>

</div>

<script>

let chart;
const MAX_POINTS=257;

/* ---------- ELEMENTS ---------- */
const chartCanvas=document.getElementById("chart");
const lutOutput=document.getElementById("lutOutput");

/* ---------- SAFE NUMBER ---------- */
function num(id,def){
let v=Number(document.getElementById(id).value);
return isFinite(v)?v:def;
}

/* ---------- AUTO PARAM FIX (MAIN MAGIC) ---------- */
function fixParams(p){

p.range=Math.max(2,Math.round(p.range||257));

p.p1cap=Math.max(1,p.p1cap);

/* enforce phase ordering automatically */
if(p.p2start<=p.p1cap)
p.p2start=p.p1cap+1;

if(p.p3start<=p.p2start)
p.p3start=p.p2start+1;

/* clamp velocities */
p.p1v=Math.max(0.01,p.p1v);
p.p2v=Math.max(p.p1v,p.p2v);
p.p3v=Math.max(p.p2v,p.p3v);

/* safe smoothing */
p.smooth=Math.min(1,Math.max(0.0001,p.smooth));

return p;
}

/* ---------- SIGMOID ---------- */
function sigmoid(x){
return 1/(1+Math.exp(-x));
}

/* ---------- RAW ACCEL SAFE ---------- */
function autoFixLUT(data){

let fixed=[];
let lastX=0.001;

fixed.push({x:lastX,y:1});

for(const p of data){

if(!p||!isFinite(p.x)||!isFinite(p.y))continue;

let x=Math.max(0.001,p.x);
let y=Math.max(0,Math.min(5,p.y));

if(x<=lastX)x=lastX+0.001;

fixed.push({x,y});
lastX=x;
}

/* enforce point limit */
if(fixed.length>MAX_POINTS){
const step=(fixed.length-1)/(MAX_POINTS-1);
let tmp=[];
for(let i=0;i<MAX_POINTS;i++){
tmp.push(fixed[Math.round(i*step)]);
}
fixed=tmp;
}

return fixed;
}

/* ---------- GENERATE ---------- */
function generateCurve(){

try{

let params=fixParams({
range:num("input_range",257),
p1v:num("phase1_velocity",6),
p2v:num("phase2_velocity",20),
p3v:num("phase3_velocity",50),
p1cap:num("phase1_cap",50),
p2start:num("phase2_start",120),
p3start:num("phase3_start",180),
smooth:num("smooth_factor",0.1)
});

let raw=[];
let xs=[];
let ys=[];

for(let x=1;x<=params.range;x++){

let y;

if(x<=params.p1cap){
y=(params.p1v/params.p1cap)*x;
}
else if(x<params.p2start){
let mid=(params.p1cap+params.p2start)/2;
y=params.p1v+(params.p2v-params.p1v)*
sigmoid(params.smooth*(x-mid));
}
else if(x<params.p3start){
let mid=(params.p2start+params.p3start)/2;
y=params.p2v+(params.p3v-params.p2v)*
sigmoid(params.smooth*(x-mid));
}
else{
y=params.p3v;
}

raw.push({x,y});
xs.push(x);
ys.push(y);
}

const safe=autoFixLUT(raw);

/* export */
lutOutput.value=safe
.map(p=>`${p.x.toFixed(3)},${p.y.toFixed(3)};`)
.join("\n");

drawChart(xs,ys);

}catch(e){
console.log("Auto recovered:",e);
}
}

/* ---------- GRAPH ---------- */
function drawChart(x,y){

if(chart)chart.destroy();

chart=new Chart(chartCanvas,{
type:"line",
data:{
labels:x,
datasets:[{
label:"Velocity Curve",
data:y,
borderColor:"white",
borderWidth:2,
pointRadius:0
}]
},
options:{
plugins:{legend:{labels:{color:"white"}}},
scales:{
x:{ticks:{color:"white"},grid:{color:"#222"}},
y:{ticks:{color:"white"},grid:{color:"#222"}}
}
}
});
}

/* ---------- COPY ---------- */
function copyLUT(){

if(!lutOutput.value.trim())return;

lutOutput.select();
document.execCommand("copy");
alert("Copied!");
}

</script>
</body>
</html>

