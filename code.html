<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Triple Phase LUT Calculator</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#000;color:#fff;font-family:Arial;margin:0;}
header{text-align:center;padding:25px;background:linear-gradient(90deg,#111,#000);}
.logo{
width:90px;height:90px;border-radius:50%;margin-bottom:10px;
box-shadow:0 0 15px rgba(255,255,255,.2);object-fit:cover;
}
.title{font-size:28px;font-weight:bold;letter-spacing:2px;}
.credit{font-size:14px;color:#aaa;}
.container{max-width:1000px;margin:auto;padding:20px;}
.card{background:#111;border-radius:15px;padding:20px;margin-bottom:20px;}
label{display:block;margin-top:12px;}
input{
width:100%;padding:8px;margin-top:5px;background:#000;
border:1px solid #333;color:#fff;border-radius:6px;
}
button{
margin-top:15px;padding:12px;width:100%;
border:none;background:#fff;color:#000;
font-weight:bold;border-radius:8px;cursor:pointer;
}
textarea{
width:100%;height:180px;background:#000;color:#fff;
border:1px solid #333;border-radius:8px;padding:10px;
margin-top:15px;font-family:monospace;
}
</style>
</head>

<body>

<header>
<img class="logo"
src="https://yt3.googleusercontent.com/G3NBG71dzJtbQ3ae2ERcVDRvXGEHaAlCO43-fnO-uilXeikc5mYWp2p2k4owzc4S5n0brzNC=s160-c-k-c0x00ffffff-no-rj">

<div class="title">Triple Phase LUT Velocity Calculator</div>
<div class="credit">Made by @igneswr</div>
</header>

<div class="container">

<div class="card">

<label>Input Range</label>
<input id="input_range" value="257">

<label>Phase 1 Velocity</label>
<input id="phase1_velocity" value="6.6">

<label>Phase 2 Velocity</label>
<input id="phase2_velocity" value="23">

<label>Phase 3 Velocity</label>
<input id="phase3_velocity" value="53">

<label>Phase 1 Cap</label>
<input id="phase1_cap" value="60">

<label>Phase 2 Start</label>
<input id="phase2_start" value="152">

<label>Phase 3 Start</label>
<input id="phase3_start" value="180">

<label>Smooth Factor</label>
<input id="smooth_factor" value="0.1">

<button onclick="generateCurve()">Generate LUT</button>
<button onclick="copyLUT()">Copy LUT</button>

<textarea id="lutOutput"></textarea>

</div>

<div class="card">
<h2>Velocity Graph</h2>
<canvas id="chart"></canvas>
</div>

</div>

<script>

let chart;
const MAX_POINTS = 257;

/* ---------- SAFE NUMBER ---------- */
function num(v, def=0){
v = Number(v);
return isFinite(v) ? v : def;
}

/* ---------- SIGMOID ---------- */
function sigmoid(x){
return 1/(1+Math.exp(-x));
}

/* ---------- LIMIT POINTS ---------- */
function limitPoints(data){

if(data.length <= MAX_POINTS) return data;

const result=[];
const step=(data.length-1)/(MAX_POINTS-1);

for(let i=0;i<MAX_POINTS;i++){
let index=Math.round(i*step);
index=Math.min(index,data.length-1);
result.push(data[index]);
}

return result;
}

/* ---------- RAW ACCEL SAFE FIX ---------- */
function autoFixLUT(data){

let fixed=[];
let lastX=0.001;

/* guaranteed valid first point */
fixed.push({x:lastX,y:1});

for(const p of data){

if(!p || !isFinite(p.x) || !isFinite(p.y)) continue;

let x=Math.max(0.001,p.x);
let y=Math.max(0,Math.min(5,p.y));

if(x<=lastX)
x=lastX+0.001;

fixed.push({x,y});
lastX=x;
}

/* ensure ending anchor */
fixed.push({
x:lastX+0.001,
y:1
});

/* enforce raw accel limit */
fixed=limitPoints(fixed);

/* FINAL STRICT PASS */
for(let i=1;i<fixed.length;i++){
if(fixed[i].x<=fixed[i-1].x){
fixed[i].x=fixed[i-1].x+0.001;
}
}

return fixed;
}

/* ---------- GENERATE ---------- */
function generateCurve(){

const input_range=Math.max(2,num(input_range.value,257));

const p1v=num(phase1_velocity.value);
const p2v=num(phase2_velocity.value);
const p3v=num(phase3_velocity.value);

const p1cap=num(phase1_cap.value);
const p2start=num(phase2_start.value);
const p3start=num(phase3_start.value);

const smooth=Math.max(0.0001,num(smooth_factor.value));

let raw=[];
let xVals=[];
let yVals=[];

for(let x=1;x<=input_range;x++){

let y=1;

if(x<=p1cap){
y=(p1v/p1cap)*x;
}
else if(x<p2start){
let mid=(p1cap+p2start)/2;
let t=sigmoid(smooth*(x-mid));
y=p1v+(p2v-p1v)*t;
}
else if(x<p3start){
let mid=(p2start+p3start)/2;
let t=sigmoid(smooth*(x-mid));
y=p2v+(p3v-p2v)*t;
}
else{
y=p3v;
}

raw.push({x,y});
xVals.push(x);
yVals.push(y);
}

const safe=autoFixLUT(raw);

/* EXPORT */
lutOutput.value = safe
.map(p=>`${p.x.toFixed(3)},${p.y.toFixed(3)};`)
.join("\n");

drawChart(xVals,yVals);
}

/* ---------- GRAPH ---------- */
function drawChart(x,y){

if(chart) chart.destroy();

chart=new Chart(chartEl,{
type:"line",
data:{
labels:x,
datasets:[{
label:"Velocity Curve",
data:y,
borderColor:"white",
borderWidth:2,
pointRadius:0
}]
},
options:{
responsive:true,
plugins:{legend:{labels:{color:"white"}}},
scales:{
x:{ticks:{color:"white"},grid:{color:"#222"}},
y:{ticks:{color:"white"},grid:{color:"#222"}}
}
}
});
}

/* ---------- COPY ---------- */
function copyLUT(){

if(!lutOutput.value.trim()){
alert("Generate LUT first");
return;
}

lutOutput.select();
document.execCommand("copy");
alert("Copied!");
}

</script>

</body>
</html>
